<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Configure Hack Portal Pebble app</title>
<meta content="True" name="HandheldFriendly">
<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="width" name="MobileOptimized">
<meta content="width=device-width,initial-scale=1" name="viewport">
<link href="https://fonts.googleapis.com/css?family=Coda" rel="stylesheet" type="text/css">
<style type="text/css">
 body {
  background-color: #000;
/*
  color: rgb(17, 236, 247);
*/
  color: #FFF;
  font-family: coda;
  font-size: 0.75em;
  padding: 0.1em;
 }
 h1 {
  color: rgb(255, 187, 0);
  font-weight: 800;
  font-size: 180%;
  margin: 0;
 }
 fieldset {
  border: 1px solid rgb(255, 187, 0);
 }
 legend {
  color: rgb(255, 187, 0);
  cursor: pointer;
 }
 table {
  margin: 0 0 1em 0;
 }
 caption {
  color: rgb(255, 187, 0);
 }
 p {
  margin: 0 0 1em 0;
 }
 label {
  display: inline-block;
  font-weight: 800;
  width: 6em;
 }
 option {
  font-size: smaller;
 }
 option.common, select.common {
  background-color: #CFC;
 }
 option.rare, select.rare {
  background-color: #DAD;
 }
 option.veryrare, select.veryrare {
  background-color: #FAD;
 }
 input[type=submit], input[type=button] {
  background-color: #000;
  border: 1px solid rgb(17, 236, 247);
  color: rgb(17, 236, 247);
  font-size: larger;
  font-weight: 400;
  margin: 0 1em 0 0;
 }
 h2 {
  margin: 1em 0 0 0;
 }
 dl {
  margin: 0;
  padding: 0;
 }
 dt {
  clear: left;
  display: block;
  float: left;
  width: 3em;
 }
 dt.common {
  color: #CFC;
 }
 dt.rare {
  color: #DAD;
 }
 dt.veryrare {
  color: #FAD;
 }
 dd {
  display: block;
  float: left;
 }

</style>
</head>
<body>
<h1>Hack Portal</h1>
<form method="get" action="pebblejs://close">
<fieldset>
<legend>[-] Portal features</legend>
<table id="mods">
<thead>
<tr><th>M</th><th>O</th><th>D</th><th>S</th></tr>
</thead>
<tbody>
<tr><td><select name="mod1"><option value="">Empty</option><option value="cooldown-20" class="common">CHS</option><option value="cooldown-50" class="rare">RHS</option><option value="cooldown-70" class="veryrare">VRHS</option><option value="hacks-4" class="common">CMH</option><option value="hacks-8" class="rare">RMH</option><option value="hacks-12" class="veryrare">VRMH</option></select></td><td><select name="mod2"><option value="">Empty</option><option value="cooldown-20" class="common">CHS</option><option value="cooldown-50" class="rare">RHS</option><option value="cooldown-70" class="veryrare">VRHS</option><option value="hacks-4" class="common">CMH</option><option value="hacks-8" class="rare">RMH</option><option value="hacks-12" class="veryrare">VRMH</option></select></td><td><select name="mod3"><option value="">Empty</option><option value="cooldown-20" class="common">CHS</option><option value="cooldown-50" class="rare">RHS</option><option value="cooldown-70" class="veryrare">VRHS</option><option value="hacks-4" class="common">CMH</option><option value="hacks-8" class="rare">RMH</option><option value="hacks-12" class="veryrare">VRMH</option></select></td><td><select name="mod4"><option value="">Empty</option><option value="cooldown-20" class="common">CHS</option><option value="cooldown-50" class="rare">RHS</option><option value="cooldown-70" class="veryrare">VRHS</option><option value="hacks-4" class="common">CMH</option><option value="hacks-8" class="rare">RMH</option><option value="hacks-12" class="veryrare">VRMH</option></select></td></tr>
</tbody>
</table>
<p class="feat"><label>Name:</label> <input type="text" size="25" name="name" value="" /></p>
<p class="feat"><label>Cooldown:</label> <input type="number" size="2" steps="1" min="0" max="300" name="cooldown" value="300"/> seconds between hacks</p>
<p class="feat"><label>Hacks:</label> <input type="number" size="2" steps="1" min="0" max="34" name="hacks" value="4" /> hacks before burnout</p>
<div><input type="hidden" name="hacktimes" value="" /><input type="submit" value="Save config" /> <input type="button" name="add" value="Add" /> <input type="button" name="del" value="Delete" /> <input type="button" name="up" value="&#9650;" title="Move up" /> <input type="button" name="down" value="&#9660;" title="Move down" /></div>
</fieldset>
</form>
<div>
<h2>Explanations for mod abbreviations</h2>
<dl>
<dt class="common">CHS</dt><dd>Common Heat Sink</dd>
<dt class="rare">RHS</dt><dd>Rare Heat Sink</dd>
<dt class="veryrare">VRHS</dt><dd>Very Rare Heat Sink</dd>
<dt class="common">CMH</dt><dd>Common Multi-hack</dd>
<dt class="rare">RMH</dt><dd>Rare Multi-hack</dd>
<dt class="veryrare">VRMH</dt><dd>Very Rare Multi-hack</dd>
</dl>
</div>
<script type="text/javascript">
 var f = document.forms[0];
 var conf;
 var elementTypes = {};
 initForm(f);
 if (document.location.hash) {
  var json = decodeURIComponent(document.location.hash.substr(1));
  if (json && (json.charAt(0) == '[')) {
   conf = JSON.parse(json);
  }
  else {
   console.log('Invalid config ' + json);
  }
  if (conf && conf.length) {
   for (var i=0; i<conf.length; i++) {
    var port = conf[i];
    document.forms[i].name.value = port.name || "";
    document.forms[i].cooldown.value = port.cooldown || f.cooldown.defaultValue;
    document.forms[i].hacks.value = port.hacks || f.hacks.defaultValue;
    document.forms[i].mod1.selectedIndex = port.mod1 || 0;
    document.forms[i].mod2.selectedIndex = port.mod2 || 0;
    document.forms[i].mod3.selectedIndex = port.mod3 || 0;
    document.forms[i].mod4.selectedIndex = port.mod4 || 0;
    document.forms[i].hacktimes.value = port.hacktimes || "";
    if (i<conf.length-1) {
     document.forms[i].add.onclick();
    }
   }
  }
 }
 function initForm(f) {
  if (!f) {
   return false;
  }
  f.onsubmit = sendConfig;
  f.add.onclick = clone;
  f.del.onclick = destroy;
  f.up.onclick = moveUp;
  f.down.onclick = moveDown;
  var sels = f.getElementsByTagName('select');
  for (var i=0; i<sels.length; i++) {
   sels[i].onchange = calculate;
  }
  var legs = f.getElementsByTagName('legend');
  for (var i=0; i<legs.length; i++) {
   legs[i].onclick = collapse;
  }
 }
 function calculate() {
  var cooldown = parseInt(this.form.cooldown.defaultValue);
  var hacks = parseInt(this.form.hacks.defaultValue);
  var coolfactor = 1;
  var multihacks = [];
  var heatsinks = []
  for (var i=1; i<=4; i++) {
   var s = this.form["mod" + i];
   var value = s.options[s.selectedIndex].value;
   s.className = s.options[s.selectedIndex].className;
   var parts = value.split('-');
   if (parts[0] == 'hacks') {
    multihacks.push(parseInt(parts[1]));
   }
   else if (parts[0] == 'cooldown') {
    heatsinks.push(parseInt(parts[1]));
   }
  }
  heatsinks.sort();
  for (var i=heatsinks.length-1; i>=0; i--) {
   // the rarest Heatsink has full effect
   // the other Heatsinks' effect is 50 %
   var divider = (i == (heatsinks.length-1)) ? 1 : 2;
   coolfactor = coolfactor * ((100 - (heatsinks[i]/divider)) / 100);
  }
  this.form.cooldown.value = parseInt(cooldown * coolfactor);
  multihacks.sort();
  for (var i=multihacks.length-1; i>=0; i--) {
   // the rarest MH has full effect
   // the other MHs' effect is 50 %
   var divider = (i == (multihacks.length-1)) ? 1 : 2;
   hacks += parseInt(multihacks[i])/divider;
  }
  this.form.hacks.value = parseInt(hacks);
 }
 function clone() {
  var parent = this.parentNode;
  while (parent.parentNode && (parent.nodeName.toLowerCase() != 'form')) {
   parent = parent.parentNode;
  }
  if (!parent) {
   return false;
  }
  var copy = parent.cloneNode(true);
  initForm(copy);
  copy.name.value = "";
  copy.cooldown.value = f.cooldown.defaultValue;
  copy.hacks.value = f.hacks.defaultValue;
  copy.hacktimes.value = "";
  parent.parentNode.insertBefore(copy, parent.nextSibling);
  return false;
 }
 function destroy() {
  var parent = this.parentNode;
  while (parent.parentNode && (parent.nodeName.toLowerCase() != 'form')) {
   parent = parent.parentNode;
  }
  if (!parent) {
   return false;
  }
  if (parent.parentNode.getElementsByTagName('form').length > 1) {
   parent.parentNode.removeChild(parent);
  }
  return false;
 }
 function moveUp() {
  var parent = this.parentNode;
  while (parent.parentNode && (parent.nodeName.toLowerCase() != 'form')) {
   parent = parent.parentNode;
  }
  if (!parent) {
   return false;
  }
  if (parent.previousSibling) {
   parent.parentNode.insertBefore(parent, parent.previousSibling);
  }
 }
 function moveDown() {
  var parent = this.parentNode;
  while (parent.parentNode && (parent.nodeName.toLowerCase() != 'form')) {
   parent = parent.parentNode;
  }
  if (!parent) {
   return false;
  }
  if (parent.nextSibling.nextSibling &&
      (parent.nextSibling.tagName.toLowerCase() == 'form')) {
   parent.parentNode.insertBefore(parent, parent.nextSibling.nextSibling);
  }
 }
 function collapse () {
  var parent = this.parentNode;
  if (!parent) {
   return false;
  }
  for (var i=0; i<parent.children.length; i++) {
   if (['table', 'p'].indexOf(parent.children[i].tagName.toLowerCase()) >= 0) {
    parent.children[i].style.display = 'none';
   }
   else {
   }
  }
  if (this.form && this.form['name']) {
   this.innerHTML = '[+] ' + (this.form['name'].value || 'Nameless portal');
  }
  this.onclick = uncollapse;
 }
 function uncollapse (legend) {
  var parent = this.parentNode;
  if (!parent) {
   return false;
  }
  for (var i=0; i<parent.children.length; i++) {
   switch (parent.children[i].tagName.toLowerCase()) {
    case 'p':
     parent.children[i].style.display = 'block';
    case 'table':
     parent.children[i].style.display = 'table';
    }
  }
  this.innerHTML = '[-]  Portal features';
  this.onclick = collapse;
 }
 function getQueryParam(variable, default_) {
  var query = location.search.substring(1);
  // work around CloudPebble issue #124
  query += location.hash.substr(location.hash.indexOf('?')+1);
  var vars = query.split('&');
  for (var i = 0; i < vars.length; i++) {
   var pair = vars[i].split('=');
   if (pair[0] == variable) {
    return decodeURIComponent(pair[1]);
   }
  }
  return default_ || false;
 }
 function sendConfig(e) {
  e.preventDefault();
  var forms = document.getElementsByTagName('form');
  var config = [];
  for (var i=0; i<forms.length; i++) {
   var f = forms[i];
   config.push({'name': f.name.value,
                'cooldown': f.cooldown.value,
                'hacks': f.hacks.value,
                'mod1': f.mod1.selectedIndex,
                'mod2': f.mod2.selectedIndex,
                'mod3': f.mod3.selectedIndex,
                'mod4': f.mod4.selectedIndex,
                'hacktimes': f.hacktimes.value});
  }
  var return_to = getQueryParam('return_to', 'pebblejs://close#');
  document.location = return_to + encodeURIComponent(JSON.stringify(config));
  return false;
 }
</script>
</body>
</html>
